<!DOCTYPE html>
<html lang="en">
<head>
<!-- –°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
<style>
  /* ... (–≤—Å–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ... */
</style>
</head>
<body>

<!-- –ì–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
<div id="authModal" class="modalOverlay active">
  <!-- ... (–∫–æ–¥ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ... -->
</div>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (—Å–∫—Ä—ã—Ç –¥–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏) -->
<div id="navbar" style="display:none" class="main-content">
  <!-- ... (–∫–æ–¥ –Ω–∞–≤–±–∞—Ä–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ... -->
</div>

<div id="container" style="display:none" class="main-content">
  <div id="matchesListPanel">
    <button id="createMatchBtn">üéÆ CREATE MATCH</button>
    <div class="neon-line"></div>
    <h2 style="color: #ff66dd; text-shadow: 0 0 5px #ff66dd;">Active Matches</h2>
    <div id="matchesList"></div>
  </div>
  <div id="chatPanel">
    <h2 style="color: #00ffff; text-shadow: 0 0 5px #00ffff;">Global Chat</h2>
    <div class="neon-line"></div>
    <div id="chatMessages"></div>
    <div id="chatInputContainer">
      <input id="chatInput" type="text" placeholder="Type a message (max 16 chars)" maxlength="16">
      <button id="chatSendBtn">Sent</button>
    </div>
  </div>
</div>

<!-- –í—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –∏–≥—Ä—ã -->
<!-- ... (–∫–æ–¥ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ... -->

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let currentUserId = null;
let currentUsername = "";
let userInv = [];
let matches = [], history = [];
let players = [];
let selectedItems = [];
let joinSelectedItems = [];
let currentJoinMatch = null;
let chatHistory = [];

// –ò–º–∏—Ç–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞ —á–µ—Ä–µ–∑ localStorage
const SERVER_DATA_KEY = "roflip_server_data";

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å "—Å–µ—Ä–≤–µ—Ä–æ–º"
function getServerData() {
  const data = localStorage.getItem(SERVER_DATA_KEY);
  return data ? JSON.parse(data) : {
    matches: [],
    chat: [],
    players: [],
    leaderboard: []
  };
}

function saveServerData(data) {
  localStorage.setItem(SERVER_DATA_KEY, JSON.stringify(data));
}

function updateServerData(callback) {
  const serverData = getServerData();
  callback(serverData);
  saveServerData(serverData);
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å localStorage
function getUsers() {
  return JSON.parse(localStorage.getItem('roflipUsers')) || [];
}

function saveUsers(users) {
  localStorage.setItem('roflipUsers', JSON.stringify(users));
}

function getCurrentUser() {
  return JSON.parse(localStorage.getItem('currentUser'));
}

function setCurrentUser(user) {
  localStorage.setItem('currentUser', JSON.stringify(user));
}

function logout() {
  localStorage.removeItem('currentUser');
  location.reload();
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function initUserData() {
  const user = getCurrentUser();
  if (!user) {
    showAuthModal();
    return;
  }
  
  currentUserId = user.id;
  currentUsername = user.username;
  userInv = user.inventory || [
    {name:"Godly Knife",value:50},
    {name:"Rare Gun",value:20},
    {name:"Epic Skin",value:30}
  ];
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
  history = user.history || [];
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å "—Å–µ—Ä–≤–µ—Ä–∞"
  const serverData = getServerData();
  matches = serverData.matches;
  players = serverData.players;
  
  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ –∏–≥—Ä–æ–∫–æ–≤, –¥–æ–±–∞–≤–ª—è–µ–º
  if (!players.some(p => p.id === user.id)) {
    players.push({
      id: user.id, 
      name: user.username, 
      totalWon: user.totalWon || 0
    });
    updateServerData(data => {
      data.players = players;
    });
  }
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
  document.getElementById('navbar').style.display = 'flex';
  document.getElementById('container').style.display = 'flex';
  document.getElementById('authModal').style.display = 'none';
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
  updateUserTotal(); 
  renderMatches();
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
  loadChatHistory();
  
  // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
  setInterval(updateFromServer, 2000);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
function loadChatHistory() {
  const serverData = getServerData();
  const chatContainer = $("chatMessages");
  chatContainer.innerHTML = "";
  
  serverData.chat.forEach(msg => {
    addChatToUI(msg.user, msg.text);
  });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å "—Å–µ—Ä–≤–µ—Ä–∞"
function updateFromServer() {
  const serverData = getServerData();
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–∞—Ç—á–µ–π
  if (JSON.stringify(matches) !== JSON.stringify(serverData.matches)) {
    matches = serverData.matches;
    renderMatches();
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —á–∞—Ç
  if ($("chatMessages").childElementCount !== serverData.chat.length) {
    const chatContainer = $("chatMessages");
    chatContainer.innerHTML = "";
    serverData.chat.forEach(msg => {
      addChatToUI(msg.user, msg.text);
    });
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∏–≥—Ä–æ–∫–æ–≤
  players = serverData.players;
}

// –ü–æ–∫–∞–∑–∞—Ç—å –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
function showAuthModal() {
  document.getElementById('authModal').style.display = 'flex';
  document.getElementById('navbar').style.display = 'none';
  document.getElementById('container').style.display = 'none';
  document.getElementById('registerForm').style.display = 'flex';
  document.getElementById('loginForm').style.display = 'none';
  document.querySelector('.auth-tab[data-tab="register"]').classList.add('active');
  document.querySelector('.auth-tab[data-tab="login"]').classList.remove('active');
  clearAuthForms();
}

// –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
function clearAuthForms() {
  document.getElementById('regUsername').value = '';
  document.getElementById('regPassword').value = '';
  document.getElementById('regConfirmPassword').value = '';
  document.getElementById('loginUsername').value = '';
  document.getElementById('loginPassword').value = '';
  document.getElementById('regError').textContent = '';
  document.getElementById('loginError').textContent = '';
  document.getElementById('regSuccess').textContent = '';
}

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function registerUser(username, password) {
  const users = getUsers();
  
  // –í–∞–ª–∏–¥–∞—Ü–∏—è
  if (!username || !password) {
    return { success: false, message: "Please fill all fields" };
  }
  
  if (password.length < 4) {
    return { success: false, message: "Password must be at least 4 characters" };
  }
  
  if (document.getElementById('regConfirmPassword').value !== password) {
    return { success: false, message: "Passwords don't match" };
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  if (users.some(u => u.username.toLowerCase() === username.toLowerCase())) {
    return { success: false, message: "Username already exists" };
  }
  
  // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const newUser = {
    id: Date.now(),
    username,
    password, // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω—É–∂–Ω–æ —Ö—ç—à–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å!
    inventory: [
      {name:"Godly Knife",value:50},
      {name:"Rare Gun",value:20},
      {name:"Epic Skin",value:30}
    ],
    history: [],
    totalWon: 0
  };
  
  users.push(newUser);
  saveUsers(users);
  setCurrentUser(newUser);
  
  // –î–æ–±–∞–≤–ª—è–µ–º –∏–≥—Ä–æ–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
  updateServerData(data => {
    data.players.push({
      id: newUser.id,
      name: newUser.username,
      totalWon: 0
    });
  });
  
  return { success: true };
}

// –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function loginUser(username, password) {
  const users = getUsers();
  
  if (!username || !password) {
    return { success: false, message: "Please fill all fields" };
  }
  
  const user = users.find(u => 
    u.username.toLowerCase() === username.toLowerCase() && 
    u.password === password // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ö—ç—à–∏
  );
  
  if (!user) {
    return { success: false, message: "Invalid username or password" };
  }
  
  setCurrentUser(user);
  return { success: true };
}

// –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function saveUserData() {
  const user = getCurrentUser();
  if (!user) return;
  
  const users = getUsers();
  const index = users.findIndex(u => u.id === user.id);
  
  if (index !== -1) {
    users[index].inventory = userInv;
    users[index].history = history;
    users[index].totalWon = players.find(p => p.id === currentUserId)?.totalWon || 0;
    saveUsers(users);
    setCurrentUser(users[index]);
  }
}

// –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–≥—Ä—ã
function renderInventory(c, arr) {
  c.innerHTML = "";
  arr.forEach(it => {
    const d = document.createElement("div");
    d.className = "item";
    d.textContent = `${it.name} (${it.value})`;
    c.appendChild(d);
  });
}

function updateUserTotal() {
  $("userTotal").textContent = userInv.reduce((a, i) => a + i.value, 0);
  $("withdrawBtn").style.display = userInv.length > 0 ? "block" : "none";
  saveUserData();
}

function cancelMatch(matchId) {
  updateServerData(data => {
    const matchIndex = data.matches.findIndex(m => m.id === matchId);
    if (matchIndex === -1) return;
    
    const match = data.matches[matchIndex];
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–µ–¥–º–µ—Ç—ã —Å–æ–∑–¥–∞—Ç–µ–ª—é
    if (match.creatorId === currentUserId) {
      const user = getCurrentUser();
      user.inventory.push(...match.creatorItems);
      setCurrentUser(user);
      saveUserData();
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
      userInv = user.inventory;
      updateUserTotal();
    }
    
    // –£–¥–∞–ª—è–µ–º –º–∞—Ç—á –∏–∑ —Å–ø–∏—Å–∫–∞
    data.matches.splice(matchIndex, 1);
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
    data.chat.push({
      user: "System",
      text: `Match #${match.id} was canceled by creator.`,
      timestamp: Date.now()
    });
  });
}

function renderMatches() {
  const ml = $("matchesList");
  ml.innerHTML = "";
  
  if (matches.length === 0) {
    ml.innerHTML = `<div style="text-align:center; padding:20px; color:#aaa;">No active matches. Create the first one!</div>`;
    return;
  }
  
  matches.forEach(m => {
    const d = document.createElement("div"); 
    d.className = "match";
    
    const creatorName = m.creatorId === currentUserId ? "You" : m.creatorName || "Player";
    const itemNames = m.creatorItems.map(i => i.name).join(", ");
    const sumC = m.creatorItems.reduce((a, i) => a + i.value, 0);
    
    let statusText = "üî¥ Waiting for opponent...";
    let buttons = "";
    
    if (m.status === "playing") {
      const opponentName = m.opponentId === currentUserId ? "You" : m.opponentName || "Player";
      const oppItems = m.opponentItems.map(i => i.name).join(", ");
      const sumO = m.opponentItems.reduce((a, i) => a + i.value, 0);
      statusText = `üü° Playing: ${creatorName} (${sumC}) vs ${opponentName} (${sumO})`;
    } else if (m.status === "finished") {
      statusText = "‚ö´ Finished";
    }
    
    if (m.status === "waiting") {
      if (m.creatorId === currentUserId) {
        // –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã –¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è
        buttons = `<button class="cancel-btn" data-match="${m.id}">CANCEL</button>`;
      } else {
        // –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
        buttons = `<button class="join-btn" data-match="${m.id}">JOIN</button>`;
      }
    }
    
    d.innerHTML = `
      <div class="match-info">
        <div class="match-row">
          <span class="match-creator">${creatorName}</span>
          <span>bet</span>
          <span class="match-items">${itemNames}</span>
          <span class="match-value">${sumC}</span>
        </div>
        <div class="match-row">
          <span class="match-status">${statusText}</span>
        </div>
      </div>
      ${buttons}
    `;
    
    ml.appendChild(d);
  });
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
  document.querySelectorAll(".join-btn").forEach(btn => {
    btn.onclick = () => {
      currentJoinMatch = matches.find(m => m.id === parseInt(btn.dataset.match));
      if (currentJoinMatch) {
        renderInventory($("joinItemsList"), userInv);
        joinSelectedItems = [];
        $("joinTotalBet").textContent = "0";
        $("joinConfirmBtn").disabled = true;
        
        openModal($("joinModal"));
        
        [...$("joinItemsList").children].forEach((el, i) => {
          el.onclick = () => {
            const it = userInv[i];
            const idx = joinSelectedItems.indexOf(it);
            
            if (idx >= 0) {
              joinSelectedItems.splice(idx, 1);
            } else {
              joinSelectedItems.push(it);
            }
            
            el.classList.toggle("selected");
            const sum = joinSelectedItems.reduce((a,i) => a + i.value, 0);
            $("joinTotalBet").textContent = sum;
            $("joinConfirmBtn").disabled = sum === 0;
          };
        });
      }
    };
  });
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –æ—Ç–º–µ–Ω—ã
  document.querySelectorAll(".cancel-btn").forEach(btn => {
    btn.onclick = () => {
      const matchId = parseInt(btn.dataset.match);
      cancelMatch(matchId);
    };
  });
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ UI
function addChatToUI(u, t) {
  const d = document.createElement("div"); 
  d.className = "chat-message";
  d.innerHTML = `<span class="chat-username">${sanitizeHTML(u)}:</span> ${sanitizeHTML(t)}`;
  $("chatMessages").appendChild(d);
  $("chatMessages").scrollTop = $("chatMessages").scrollHeight;
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç (—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
function addChat(u, t) {
  updateServerData(data => {
    data.chat.push({
      user: u,
      text: t,
      timestamp: Date.now()
    });
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
    if (data.chat.length > 50) {
      data.chat = data.chat.slice(-50);
    }
  });
  
  // –î–æ–±–∞–≤–ª—è–µ–º –≤ UI
  addChatToUI(u, t);
}

function openModal(m) {
  m.classList.add("active");
  m.querySelector(".modal").style.animation = "fadeInZoom 0.3s ease";
}

function closeModal(m) {
  const mo = m.querySelector(".modal");
  mo.style.animation = "fadeOutZoom 0.2s ease";
  setTimeout(() => m.classList.remove("active"), 200);
}

function createMatch(items) {
  if (!items || items.length === 0) return;
  
  items.forEach(it => {
    const i = userInv.indexOf(it);
    if (i >= 0) userInv.splice(i, 1);
  });
  
  const matchId = Date.now();
  const sumC = items.reduce((a, i) => a + i.value, 0);
  
  updateServerData(data => {
    data.matches.push({
      id: matchId,
      creatorId: currentUserId,
      creatorName: currentUsername,
      creatorItems: items.slice(),
      opponentId: null,
      opponentName: "",
      opponentItems: [],
      status: "waiting"
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
    data.chat.push({
      user: "System",
      text: `${currentUsername} created match #${matchId} with items: ${items.map(i => i.name).join(", ")} (${sumC})`,
      timestamp: Date.now()
    });
  });
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–≥—Ä–æ–∫–∞
  updateServerData(data => {
    const player = data.players.find(p => p.id === currentUserId);
    if (player) {
      player.totalWon -= sumC;
    }
  });
  
  updateUserTotal();
}

function joinMatch(matchId, items) {
  if (!items || items.length === 0) return;
  
  let match;
  
  updateServerData(data => {
    const m = data.matches.find(x => x.id === matchId);
    if (!m || m.status !== "waiting") return;
    
    m.opponentId = currentUserId;
    m.opponentName = currentUsername;
    m.opponentItems = items;
    m.status = "playing";
    
    match = {...m};
    
    const sumC = m.creatorItems.reduce((a, i) => a + i.value, 0);
    const sumO = items.reduce((a, i) => a + i.value, 0);
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
    data.chat.push({
      user: "System",
      text: `${currentUsername} joined match #${matchId} with items: ${items.map(i => i.name).join(", ")} (${sumO})`,
      timestamp: Date.now()
    });
    data.chat.push({
      user: "System",
      text: `Match #${matchId} started: ${sumC} vs ${sumO}`,
      timestamp: Date.now()
    });
  });
  
  // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥–º–µ—Ç—ã –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
  items.forEach(it => {
    const i = userInv.indexOf(it);
    if (i >= 0) userInv.splice(i, 1);
  });
  
  updateUserTotal();
  
  setTimeout(() => {
    const winner = Math.random() < 0.5 ? 'creator' : 'opponent';
    const winnerId = winner === 'creator' ? match.creatorId : match.opponentId;
    const isCurrentUserWinner = winnerId === currentUserId;
    
    updateServerData(data => {
      const mIndex = data.matches.findIndex(m => m.id === matchId);
      if (mIndex !== -1) {
        data.matches.splice(mIndex, 1);
      }
    });
    
    const allItems = match.creatorItems.concat(match.opponentItems);
    const totalValue = match.creatorItems.reduce((a, i) => a + i.value, 0) + 
                       match.opponentItems.reduce((a, i) => a + i.value, 0);
    
    const record = {
      time: new Date(),
      won: isCurrentUserWinner,
      items: allItems,
      amount: totalValue,
      opponent: winner === 'creator' ? match.creatorName : match.opponentName
    };
    
    history.unshift(record);
    saveUserData();
    
    if (isCurrentUserWinner) {
      userInv.push(...allItems);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–≥—Ä–æ–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
      updateServerData(data => {
        const player = data.players.find(p => p.id === currentUserId);
        if (player) {
          player.totalWon += totalValue;
        }
      });
    }
    
    $("#coinResult").textContent = isCurrentUserWinner ? 'YOU WON!' : 'YOU LOST!';
    $("#coinResult").style.color = isCurrentUserWinner ? '#00ff00' : '#ff0000';
    
    if (isCurrentUserWinner) {
      $("#resultText").innerHTML = `
        <p>You won <span style="color:#00ff00; font-weight:bold">${totalValue}</span> value!</p>
        <p>Received items: ${allItems.map(i => i.name).join(", ")}</p>
      `;
    } else {
      $("#resultText").innerHTML = `
        <p>You lost!</p>
        <p><span style="color:#ff5555; font-weight:bold">${winner === 'creator' ? match.creatorName : match.opponentName}</span> won with ${totalValue} value</p>
      `;
    }
    
    openModal($("resultModal"));
    updateUserTotal();
  }, 2000);
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function $(id) { return document.getElementById(id); }

function sanitizeHTML(str) {
  return str.replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
function initEventListeners() {
  // –ß–∞—Ç
  $("chatSendBtn").onclick = () => {
    let t = $("chatInput").value.trim();
    if (!t) return;
    
    if (t.length > 16) {
      t = t.substring(0, 16);
      $("chatInput").value = t;
    }
    
    addChat(currentUsername, t); 
    $("chatInput").value = "";
  };

  $("chatInput").addEventListener("keydown", e => { 
    if (e.key==="Enter") $("chatSendBtn").click(); 
  });

  // –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ç—á–∞
  $("createMatchBtn").onclick = () => {
    renderInventory($("pickItems"), userInv);
    selectedItems = []; 
    $("totalBet").textContent = "0"; 
    $("pickConfirmBtn").disabled = true;
    
    openModal($("pickModal"));
    
    [...$("pickItems").children].forEach((el, i) => {
      el.onclick = function() {
        const it = userInv[i];
        const idx = selectedItems.indexOf(it);
        
        if (idx >= 0) {
          selectedItems.splice(idx, 1);
        } else {
          selectedItems.push(it);
        }
        
        el.classList.toggle("selected");
        const sum = selectedItems.reduce((a,i) => a + i.value, 0);
        $("totalBet").textContent = sum;
        $("pickConfirmBtn").disabled = sum === 0;
      };
    });
  };

  $("pickConfirmBtn").onclick = () => {
    if (selectedItems.length) { 
      createMatch(selectedItems); 
      closeModal($("pickModal")); 
    }
  };

  // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –º–∞—Ç—á—É
  $("joinConfirmBtn").onclick = () => {
    if (joinSelectedItems.length && currentJoinMatch) { 
      joinMatch(currentJoinMatch.id, joinSelectedItems); 
      closeModal($("joinModal")); 
    }
  };

  // –†–µ–∑—É–ª—å—Ç–∞—Ç
  $("resultCloseBtn").onclick = () => closeModal($("resultModal"));

  // –ü—Ä–æ—Ñ–∏–ª—å
  $("profileBtn").onclick = () => {
    renderInventory($("yourItemsList"), userInv); 
    updateUserTotal();
    openModal($("profileModal"));
    
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.onclick = function() {
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
        this.classList.add("active");
        $(this.dataset.tab).classList.add("active");
        
        if (this.dataset.tab === "historyTab") {
          const hl = $("historyList");
          hl.innerHTML = "";
          
          if (history.length === 0) {
            hl.innerHTML = `<li style="text-align:center; padding:20px; color:#aaa;">No match history yet</li>`;
            return;
          }
          
          history.forEach(h => {
            const d = new Date(h.time);
            const itemsText = h.items.map(i => i.name).join(", ");
            const wonText = h.won ? 
              `<span style="color:#00ff00">WON</span> vs ${h.opponent}` : 
              `<span style="color:#ff5555">LOST</span> vs ${h.opponent}`;
            const li = document.createElement("li");
            li.innerHTML = `
              <div><strong>${d.toLocaleString()}</strong></div>
              <div>${wonText} - ${itemsText} (<strong>${h.amount}</strong>)</div>
            `;
            hl.appendChild(li);
          });
        }
      };
    });
  };

  // –î–µ–ø–æ–∑–∏—Ç/–≤—ã–≤–æ–¥
  $("depositBtn").onclick = () => openModal($("depositModal"));
  $("withdrawBtn").onclick = () => openModal($("withdrawModal"));

  // –ë–æ—Ç—ã
  document.querySelectorAll(".bot-btn").forEach(btn => {
    btn.onclick = function() {
      const botName = this.dataset.bot;
      const isDeposit = this.closest("#depositModal");
      const message = isDeposit 
        ? `To deposit items, please visit: https://example.com/deposit\nMake sure to trade with ${botName}!` 
        : `To withdraw items, please visit: https://example.com/withdraw\nSend trade offer to ${botName}!`;
      alert(message);
    };
  });

  // –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤
  $("leaderboardBtn").onclick = () => {
    const lst = $("leaderboardList"); 
    lst.innerHTML = "";
    
    // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
    const serverData = getServerData();
    const players = serverData.players || [];
    
    players.sort((a,b) => b.totalWon - a.totalWon)
      .slice(0,5)
      .forEach((p,i) => {
        const li = document.createElement("li");
        li.innerHTML = `
          <span class="name">${i+1}. ${p.name}</span>
          <span style="color:#00ffcc; font-weight:bold">${p.totalWon}</span>
        `;
        lst.appendChild(li);
      });
    
    openModal($("leaderboardModal"));
  };
  
  // –í—ã—Ö–æ–¥
  $("logoutBtn").onclick = logout;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
function initAuthListeners() {
  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π –∏ –≤—Ö–æ–¥–æ–º
  document.querySelectorAll('.auth-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      
      if (this.dataset.tab === 'register') {
        document.getElementById('registerForm').style.display = 'flex';
        document.getElementById('loginForm').style.display = 'none';
      } else {
        document.getElementById('registerForm').style.display = 'none';
        document.getElementById('loginForm').style.display = 'flex';
      }
      
      clearAuthForms();
    });
  });
  
  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ —Å—Å—ã–ª–∫–µ
  document.querySelectorAll('.auth-switch').forEach(link => {
    link.addEventListener('click', function() {
      const isRegister = this.textContent.includes('Login');
      document.querySelector(`.auth-tab[data-tab="${isRegister ? 'login' : 'register'}"]`).click();
    });
  });
  
  // –ö–Ω–æ–ø–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  document.getElementById('registerBtn').addEventListener('click', function() {
    const username = document.getElementById('regUsername').value.trim();
    const password = document.getElementById('regPassword').value;
    const confirmPassword = document.getElementById('regConfirmPassword').value;
    
    const result = registerUser(username, password);
    if (result.success) {
      document.getElementById('regSuccess').textContent = 'Account created successfully!';
      document.getElementById('regError').textContent = '';
      
      // –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
      setTimeout(() => {
        document.getElementById('authModal').style.opacity = '0';
        setTimeout(() => {
          initUserData();
        }, 500);
      }, 1000);
    } else {
      document.getElementById('regError').textContent = result.message;
      document.getElementById('regSuccess').textContent = '';
    }
  });
  
  // –ö–Ω–æ–ø–∫–∞ –≤—Ö–æ–¥–∞
  document.getElementById('loginBtn').addEventListener('click', function() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    
    const result = loginUser(username, password);
    if (result.success) {
      // –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞
      document.getElementById('authModal').style.opacity = '0';
      setTimeout(() => {
        initUserData();
      }, 500);
    } else {
      document.getElementById('loginError').textContent = result.message;
    }
  });
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter –≤ —Ñ–æ—Ä–º–∞—Ö
  document.getElementById('regPassword').addEventListener('keydown', e => {
    if (e.key === 'Enter') document.getElementById('registerBtn').click();
  });
  
  document.getElementById('regConfirmPassword').addEventListener('keydown', e => {
    if (e.key === 'Enter') document.getElementById('registerBtn').click();
  });
  
  document.getElementById('loginPassword').addEventListener('keydown', e => {
    if (e.key === 'Enter') document.getElementById('loginBtn').click();
  });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
  initAuthListeners();
  initEventListeners();
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  if (getCurrentUser()) {
    initUserData();
  } else {
    showAuthModal();
  }
});
</script>
</body>
</html>
